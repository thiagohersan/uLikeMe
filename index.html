<!DOCTYPE html>
<html>
<head>
  <title>uLikeMe (on Facebook)</title>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="description" content="uLikeMe (on Facebook) is an app for allowing other people to love you (on Facebook)">
  <meta name="keywords" content="art, like, poke, app">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" type="text/css" href="css.css" />
  <link rel="shortcut icon" href="/imgs/favicon.ico" type="image/x-icon">

  <link href='http://fonts.googleapis.com/css?family=Lato:100,300,400,700' rel='stylesheet' type='text/css'>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>

  <meta property="og:title" content="uLikeMe (on Facebook)" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="http://ulikeme.thiagohersan.com/" />
  <meta property="og:image" content="http://ulikeme.thiagohersan.com/imgs/uLikeMe500.png" />
  <meta property="og:description" content="uLikeMe (on Facebook) is an app for allowing other people to love you (on Facebook)" />

</head>
<body>
  <div id="fb-root"></div>
  <script>

  var myWebSocket, myId;

  // Load the SDK asynchronously
  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));

  window.fbAsyncInit = function() {
    FB.init({
      appId      : '499753440145658',
      version    : 'v2.10',
      status     : true, // check login status
      cookie     : true, // enable cookies to allow the server to access the session
      xfbml      : true  // parse XFBML
    });

    FB.Event.subscribe('auth.authResponseChange', function(response) {
      if (response.status == 'connected') {
        myId = response.authResponse.userID;
        onLogIn(response);
      }
    });
  };

  function logMeIn(){
    FB.login(function(){}, {scope: "publish_actions"});
  }
  function onLogIn(response) {
    if(('status' in response) && (response.status == 'connected')){
      // connect to heroku app, get list of clients
      myWebSocket = new WebSocket("ws://ulikeme-server.herokuapp.com/observer?id="+myId);
      myWebSocket.onopen = function(){ setInterval(function(){ console.log("PING"); myWebSocket.send("PING"); }, 10000); };
      myWebSocket.onmessage = function (event) {
        if('data' in event){
          var data = JSON.parse(event.data);
          if('clientIds' in data){
            var clientIds = data['clientIds'];
            /* client selector */
            FB.ui({method: 'apprequests',
              message: 'I got my eyes on you!',
              title: 'I got my eyes on you!',
              filters: [{name: 'I got my eyes on you!', user_ids: clientIds}],
              max_recipients: 1
            }, clientSelectorCallback);
          }
          else if('postIds' in data){
            var postIds = data['postIds'];
            for(var i=0; i<postIds.length; i++){
              FB.api(postIds[i]+"/likes", 'post', function(response){console.log(response)});
            }
            if(postIds.length>0){
              showFeedback();
            }
          }
        }
      };
    }
  }
  function clientSelectorCallback(pickerResponse){
    // send request to server (should only be one, but just in case)
    for(var i=0; (pickerResponse != null)&&('to' in pickerResponse)&&(i<pickerResponse.to.length); i++) {
      myWebSocket.send(JSON.stringify({observer: myId, client: pickerResponse.to[i]}));
    }
  }

  function centerHoverMap(){
    var eyeImgWidth = $('#eye-img').width();
    var eyeImgXOffset = $('#eye-img').offset().left;

    $('#roll-over-area').css('width', eyeImgWidth/4+'px');
    $('#roll-over-area').css('height', eyeImgWidth/4+'px');
    $('#roll-over-area').css('top', (eyeImgWidth/2 - eyeImgWidth/8)+'px');
    $('#roll-over-area').css('left', (eyeImgXOffset + eyeImgWidth/2 - eyeImgWidth/8)+'px');
  }
  function showFeedback(){
    $("#post-feedback").css('opacity', 1.0);
    setTimeout(function(){ $("#post-feedback").css('opacity', 0.0); }, 2000);
  }

  $(window).load(function() {
    centerHoverMap();
    $('#roll-over-area').hover(
      function(){ $('#eye-img').attr("src","imgs/uLikeMe666_S2.png"); },
      function() { $('#eye-img').attr("src","imgs/uLikeMe666.png"); }
      );
  });
  $(window).resize(centerHoverMap);


  </script>

  <div id="main-body">
    <div id="logo-button">
      <img id="eye-img" src="imgs/uLikeMe666.png">
      <div id="roll-over-area" onclick="logMeIn()"></div>
    </div>
  </div>

  <div class="fb-like"
    id="fb-like"
    data-href="http://ulikeme.thiagohersan.com/"
    data-layout="box_count"
    data-action="like"
    data-show-faces="false"
    data-share="false">
  </div>

  <div id="about" class="bottom-links">
    <a href="http://thiagohersan.com/project/ulikeme-on-facebook/" target="_blank">Info</a>
  </div>

  <div id="post-feedback">
    Success!
  </div>

  <div id="credit" class="bottom-links">
    <a href="http://www.thiagohersan.com/" target="_blank">Thiago Hersan</a>
  </div>

</body>
</html>
